<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o | Painel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style_painel.css">
    <link rel="stylesheet" href="style_produtividade.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>

<body>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="profile-section">
                <div class="avatar-wrapper">
                    <img id="user-photo" src="https://via.placeholder.com/150" alt="Foto de Perfil">
                </div>
                <div class="profile-info">
                    <h3 id="user-name">Carregando...</h3>
                    <p id="user-role-display">Cargo</p>
                    <p id="user-matricula" style="font-size: 0.75rem; color: #94a3b8; margin-top: 2px;">Matr√≠cula: ---
                    </p>
                </div>
            </div>

            <nav class="nav-menu">
                <button class="nav-btn active" onclick="mudarAba('home')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8" />
                        <path
                            d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    </svg>
                    Home
                </button>

                <!-- Bot√µes vis√≠veis apenas para FISCAL -->
                <div id="fiscal-options" style="display: none;">
                    <button class="nav-btn" onclick="mudarAba('produtividade')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v16a2 2 0 0 0 2 2h16" />
                            <path d="M7 16l4-8 4 4 4-8" />
                        </svg>
                        Produtividade
                    </button>
                    <button class="nav-btn" onclick="mudarAba('historico')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                        Hist√≥rico
                    </button>
                    <button class="nav-btn" onclick="mudarAba('historico-geral')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                            <path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z" />
                            <path d="M12 11h4" />
                            <path d="M12 16h4" />
                            <path d="M8 11h.01" />
                            <path d="M8 16h.01" />
                        </svg>
                        Hist√≥rico Geral
                    </button>
                </div>
                <div id="admin-options" style="display: none;">
                    <div class="nav-divider">ADMINISTRA√á√ÉO</div>
                    <button class="nav-btn" onclick="mudarAba('usuarios')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                        Usu√°rios
                    </button>
                </div> <!-- /admin-options -->

                <div class="nav-divider"></div>
                <button class="nav-btn" onclick="mudarAba('configuracoes')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    Configura√ß√µes
                </button>
            </nav>

            <button class="logout-footer" onclick="sair()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                <span>Sair do Sistema</span>
            </button>
        </aside>

        <main class="main-content">
            <!-- ABA: HOME -->
            <section id="aba-home" class="content-section">
                <h1>Home</h1>

                <div id="home-produtividade-container" style="display:none;">
                    <div class="pontuacao-resumo" style="margin-top: 2rem;">
                        <div class="pontuacao-card">
                            <h3>Pontua√ß√£o Total</h3>
                            <div class="valor" id="pontuacao-resumo-total">0</div>
                            <div id="meta-2000" class="meta-badge" style="display:none;">üèÜ META ATINGIDA!</div>
                        </div>
                        <div class="pontuacao-card">
                            <h3>Registros</h3>
                            <div class="valor" id="total-registros">0</div>
                        </div>
                        <div class="pontuacao-card pontuacao-card-acao">
                            <button class="btn-relatorio" onclick="abrirRelatorio()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <line x1="16" y1="13" x2="8" y2="13" />
                                    <line x1="16" y1="17" x2="8" y2="17" />
                                </svg>
                                Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>

                    <div class="grafico-container">
                        <h3>Produtividade por Dia</h3>
                        <canvas id="grafico-produtividade" height="200"></canvas>
                    </div>
                </div>
            </section>

            <!-- ABA: PRODUTIVIDADE (s√≥ fiscal) -->
            <section id="aba-produtividade" class="content-section" style="display: none;">
                <h1 class="secao-titulo-prod">Produtividade</h1>

                <div class="pontuacao-resumo">
                    <div class="pontuacao-card">
                        <h3>Pontua√ß√£o Total</h3>
                        <div class="valor" id="pontuacao-prod-total">0</div>
                    </div>
                    <div class="pontuacao-card">
                        <h3>Registros</h3>
                        <div class="valor" id="total-registros-prod">0</div>
                    </div>
                </div>

                <div class="categorias-grid" id="categorias-grid">
                    <!-- Preenchido dinamicamente pelo JS -->
                </div>
            </section>

            <!-- ABA: HIST√ìRICO (s√≥ fiscal) -->
            <section id="aba-historico" class="content-section" style="display: none;">
                <h1 class="secao-titulo-prod">Hist√≥rico de Produtividade</h1>


                <div class="pontuacao-resumo">
                    <div class="pontuacao-card">
                        <h3>Pontua√ß√£o Total</h3>
                        <div class="valor" id="pontuacao-total">0</div>
                    </div>
                    <div class="pontuacao-card">
                        <h3>Registros</h3>
                        <div class="valor" id="total-registros-hist">0</div>
                    </div>
                </div>

                <div class="filtros-historico">
                    <div class="filtro-grupo">
                        <label for="filtro-categoria">Categoria</label>
                        <select id="filtro-categoria" class="sub-aba-btn" onchange="filtrarHistorico()"
                            style="margin: 0; outline: none; width: 100%; min-width: 200px; padding: 10px 15px;">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label for="filtro-busca">Buscar</label>
                        <input type="text" id="filtro-busca" placeholder="Pesquisar nos registros..."
                            oninput="filtrarHistorico()">
                    </div>
                </div>

                <div class="historico-container" id="historico-lista">
                    <div class="historico-vazio">
                        Nenhum registro de produtividade ainda.<br>
                        V√° em Produtividade e registre suas atividades!
                    </div>
                </div>
            </section>

            <!-- ABA: HIST√ìRICO GERAL (Controle Processual) -->
            <section id="aba-historico-geral" class="content-section" style="display: none;">
                <h1>Hist√≥rico Geral ‚Äî Controle Processual</h1>

                <div class="sub-abas-cp">
                    <button class="sub-aba-btn active" onclick="mudarSubAbaCP('1.1', this)">NP</button>
                    <button class="sub-aba-btn" onclick="mudarSubAbaCP('1.2', this)">Auto Infra√ß√£o</button>
                    <button class="sub-aba-btn" onclick="mudarSubAbaCP('1.3', this)">AR</button>
                    <button class="sub-aba-btn" onclick="mudarSubAbaCP('1.4', this)">Of√≠cio</button>
                    <button class="sub-aba-btn" onclick="mudarSubAbaCP('1.5', this)">Relat√≥rio</button>
                    <button class="sub-aba-btn" onclick="mudarSubAbaCP('1.6', this)">Protocolo</button>
                    <button class="sub-aba-btn" onclick="mudarSubAbaCP('1.7', this)">R√©plica</button>
                </div>

                <div class="busca-geral-container" style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="busca-historico-geral"
                            placeholder="Pesquisar por N¬∞, Nome, Bairro ou N¬∞ Inscri√ß√£o..."
                            oninput="filtrarHistoricoGeral()" style="width: 100%;">
                    </div>
                    <select id="filtro-bairro-historico" class="sub-aba-btn" onchange="filtrarHistoricoGeral()"
                        style="outline: none; min-width: 180px; max-width: 250px; height: 100%;">
                        <option value="">Todos os Bairros</option>
                    </select>
                </div>

                <div id="historico-geral-lista">
                    <div class="historico-vazio">Selecione uma categoria acima.</div>
                </div>
            </section>

            <!-- ABA: TAREFAS -->
            <section id="aba-tarefas" class="content-section" style="display: none;">
                <h1>Minhas Tarefas</h1>
                <p>Aqui aparecer√° o seu hist√≥rico de tarefas.</p>
            </section>

            <!-- ABA: CONFIGURA√á√ïES (Perfil) -->
            <section id="aba-configuracoes" class="content-section" style="display: none;">
                <h1>Meu Perfil</h1>
                <div class="perfil-container">
                    <div class="perfil-avatar-sec">
                        <div class="avatar-grande-wrapper">
                            <img id="perfil-foto-preview" src="https://via.placeholder.com/150" alt="Sua Foto">
                            <label for="upload-avatar" class="btn-trocar-foto">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                    <circle cx="12" cy="13" r="4" />
                                </svg>
                            </label>
                            <input type="file" id="upload-avatar" accept="image/*" style="display: none;"
                                onchange="uploadAvatarLocal(event)">
                        </div>
                        <p class="avatar-help">Clique no √≠cone para alterar sua foto.</p>
                        <p id="upload-status" style="font-size: 0.8rem; color: #64748b; margin-top: 5px;"></p>
                        <span class="link-redefinir-senha" onclick="mostrarFormSenha()">Redefinir Senha</span>
                    </div>

                    <div class="perfil-dados-sec">
                        <div class="input-group">
                            <label>Nome Completo</label>
                            <input type="text" id="perfil-nome" readonly>
                        </div>
                        <div class="input-group">
                            <label>Login (CPF)</label>
                            <input type="text" id="perfil-cpf" readonly>
                        </div>
                        <div class="input-group">
                            <label>Matr√≠cula</label>
                            <input type="text" id="perfil-matricula" readonly>
                        </div>
                        <div class="input-group">
                            <label>Cargo Atual</label>
                            <input type="text" id="perfil-cargo" readonly class="input-destaque">
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL FLUTUANTE (Formul√°rio de registro) -->
    <div class="modal-overlay" id="modal-produtividade">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modal-titulo">Categoria</h2>
                <button class="modal-close" onclick="fecharModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="modal-campos">
                <!-- Campos gerados dinamicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn-cancelar" onclick="fecharModal()">Cancelar</button>
                <button class="btn-salvar" onclick="salvarRegistro()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE DETALHES (ao clicar em um registro) -->
    <div class="modal-overlay" id="modal-detalhes">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="detalhe-titulo">Detalhes</h2>
                <button class="modal-close" onclick="fecharDetalhes()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detalhe-campos">
                <!-- Detalhes gerados dinamicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn-excluir" onclick="excluirRegistro()">Excluir</button>
                <button class="btn-salvar" onclick="editarRegistro()">Editar</button>
            </div>
        </div>
    </div>

    <!-- MODAL REDEFINIR SENHA -->
    <div class="modal-overlay" id="modal-senha" style="display: none;">
        <div class="modal-container" style="max-width: 450px;">
            <div class="modal-header">
                <h2>Redefinir Senha</h2>
                <button class="modal-close" onclick="fecharModalSenha()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Senha Antiga</label>
                    <input type="password" id="senha-antiga" placeholder="Digite sua senha atual"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border-soft); border-radius: 8px;">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Nova Senha</label>
                    <input type="password" id="nova-senha" placeholder="M√≠nimo 6 caracteres"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border-soft); border-radius: 8px;">
                </div>
                <div class="input-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" id="confirmar-senha" placeholder="Repita a nova senha"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border-soft); border-radius: 8px;">
                </div>
                <p id="msg-senha" style="font-size: 0.85rem; margin-top: 15px; text-align: center; height: 1.2em;"></p>
            </div>
            <div class="modal-footer" style="justify-content: flex-end; gap: 10px;">
                <button class="btn-cancelar" onclick="fecharModalSenha()">Cancelar</button>
                <button class="btn-salvar" onclick="alterarSenha()">Alterar Senha</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITOR DE DOCUMENTO (WYSIWYG) -->
    <div class="modal-overlay" id="modal-editor-documento" style="display: none; z-index: 2000;">
        <div class="modal-container"
            style="max-width: 900px; width: 95%; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>Pr√©-visualiza√ß√£o e Edi√ß√£o</h2>
                <button class="modal-close" onclick="fecharEditorDocumento()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>

            <div class="modal-body"
                style="flex: 1; overflow-y: auto; background: #e2e8f0; padding: 20px; display: flex; justify-content: center;">
                <!-- Papel A4 -->
                <div id="editor-texto" contenteditable="true" style="
                    background: white; 
                    width: 210mm; 
                    min-height: 297mm; 
                    padding: 20mm; 
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
                    outline: none;
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 12pt;
                    line-height: 1.5;
                    color: black;
                ">
                </div>
            </div>

            <div class="modal-footer" style="justify-content: space-between;">
                <button class="btn-cancelar" onclick="fecharEditorDocumento()">Voltar ao Formul√°rio</button>
                <div style="display: flex; gap: 10px;">
                    <button id="btn-exporta-word" class="btn-salvar" style="background: #2563eb;"
                        onclick="baixarDocumentoWord()">Baixar Word (.doc)</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="protecao.js"></script>
    <script src="painel.js"></script>
    <script src="produtividade.js"></script>
</body>

</html>